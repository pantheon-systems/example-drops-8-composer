# https://circleci.com/docs/configuration#machine
machine:
  timezone:
    America/Chicago
  php:
    # https://circleci.com/docs/build-image-trusty/#php
    version: 7.0.11
  environment:
    TEST_SITE_NAME: Example D8 Composer Test Site
    ADMIN_EMAIL: admin@example.com
    TERMINUS_SITE: ci-example-d8-composer
    PR_LABEL: ${CI_PULL_REQUEST:+pr-$CIRCLE_BRANCH}
    CI_LABEL: ci-$CIRCLE_BUILD_NUM
    TERMINUS_ENV: $(echo ${PR_LABEL:-$CI_LABEL} | cut -c -11)
    TERMINUS_ENV_LABEL: CI-$CIRCLE_BUILD_NUM
    MULTIDEV_DELETE_PATTERN: ^ci-
    PR_DELETE_PATTERN: ^pr-
    PATH: $PATH:~/.composer/vendor/bin:~/.config/composer/vendor/bin:tests/scripts

dependencies:
  cache_directories:
    - ~/.composer/cache
  pre:
    # Avoid ssh prompting when connecting to new ssh hosts
    - echo "Begin build for $CI_LABEL${PR_LABEL:+ for }$PR_LABEL. Pantheon test environment is $TERMINUS_SITE.$TERMINUS_ENV"
    - echo "StrictHostKeyChecking no" >> "$HOME/.ssh/config"
    - |
      if [ -n "$GITHUB_TOKEN" ] ; then
        composer config --global github-oauth.github.com $GITHUB_TOKEN
      fi
    - git config --global user.email "$GIT_EMAIL"
    - git config --global user.name "Circle CI"
  override:
    - composer global require "hirak/prestissimo:^0.3"
    - composer global require "consolidation/cgr"
    - cgr "pantheon-systems/terminus:~1" --stability beta
    - terminus --version
    - cgr "drush/drush:~8"
    - mkdir -p ~/.terminus/plugins
    - composer create-project -d ~/.terminus/plugins pantheon-systems/terminus-build-tools-plugin:~1
  post:
    - terminus auth:login --machine-token="$TERMINUS_TOKEN"
    - terminus build-env:delete "$TERMINUS_SITE" "$MULTIDEV_DELETE_PATTERN" --keep=2 --delete-branch --yes
    - composer build-assets
    - terminus env:wake "$TERMINUS_SITE.dev"
    - terminus build-env:create "$TERMINUS_SITE.dev" "$TERMINUS_ENV" --label="$TERMINUS_ENV_LABEL"
    - scripts/github/add-commit-comment
test:
  override:
    - run-behat

deployment:
  build-assets:
    branch: master
    commands:
      - terminus build-env:merge "$TERMINUS_SITE.$TERMINUS_ENV" --label="$TERMINUS_ENV_LABEL"
      - terminus build-env:delete "$TERMINUS_SITE" "$PR_DELETE_PATTERN" --preserve-prs --delete-branch --yes
      - terminus drush $TERMINUS_SITE.dev -- updatedb --yes
